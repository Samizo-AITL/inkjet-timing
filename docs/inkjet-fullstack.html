<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Inkjet Full-stack Timing</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
:root{
  --bg:#0b0d10;
  --panel:#12161c;
  --fg:#d6d9df;
  --muted:#9aa3ad;
  --border:#232a33;
}
*{ box-sizing:border-box; }
body{
  margin:0;
  background:var(--bg);
  color:var(--fg);
  font-family:system-ui;
}
.wrap{
  max-width:1200px;
  margin:0 auto;
  padding:12px;
}
.header{
  display:flex;
  justify-content:space-between;
  align-items:flex-end;
}
h2{ margin:0; font-size:20px; }
.sub{ font-size:12px; color:var(--muted); }

.main{
  display:grid;
  grid-template-columns: 1fr 340px;
  gap:12px;
  margin-top:10px;
}

/* ===== scope panel ===== */
.scopeCard{
  border:1px solid var(--border);
  border-radius:12px;
  background:#000;
  padding:10px;
}
canvas{
  width:100%;
  display:block;
}

/* ===== control panel ===== */
.panel{
  border:1px solid var(--border);
  border-radius:12px;
  background:var(--panel);
  padding:12px;
  max-height:640px;
  overflow-y:auto;
}
label{ font-size:12px; display:block; margin-top:12px; }
input[type="range"]{ width:100%; }
.status{
  font-family:ui-monospace;
  font-size:12px;
  color:var(--muted);
  margin-top:8px;
}
</style>
</head>

<body>
<div class="wrap">
  <div class="header">
    <div>
      <h2>Inkjet Full-stack Timing</h2>
      <div class="sub">
        V(t) → I(t) → Δx(t) → P(t) → Q(t)  
        (fixed waveforms + time cursor, oscilloscope-style)
      </div>
    </div>
    <div class="status" id="status"></div>
  </div>

  <div class="main">
    <!-- ===== left: scope ===== -->
    <div class="scopeCard">
      <canvas id="c"></canvas>
    </div>

    <!-- ===== right: controls ===== -->
    <div class="panel">
      <label>
        <input id="damper" type="checkbox" checked>
        Acoustic damper
      </label>

      <label>Damper strength</label>
      <input id="damper_strength" type="range" min="0" max="1" step="0.02">

      <label>Drive amplitude V_amp [V]</label>
      <input id="V_amp" type="range" min="5" max="80" step="1">

      <label>Base damping ζ</label>
      <input id="zeta" type="range" min="0.02" max="0.55" step="0.01">

      <label>Reflection delay [µs]</label>
      <input id="refl_delay" type="range" min="1" max="14" step="0.2">

      <label>Ring frequency f0 [1/µs]</label>
      <input id="f0" type="range" min="0.05" max="0.6" step="0.01">

      <label>Reflection gain</label>
      <input id="refl_gain" type="range" min="0" max="1" step="0.02">
    </div>
  </div>
</div>

<script type="module">
import { params } from "./params.js";
import { computeStack } from "./model.js";
import { drawStack } from "./draw.js";

const canvas = document.getElementById("c");

/* ===== CRITICAL FIX: canvas height is defined by JS, not CSS ===== */
function setupCanvas(){
  const dpr = window.devicePixelRatio || 1;

  const CHANNELS = 5;      // V, I, Δx, P, Q
  const ROW_H = 110;       // px per channel (logical)
  const PAD_T = 10;
  const PAD_B = 10;

  const logicalHeight = CHANNELS * ROW_H + PAD_T + PAD_B;

  const rect = canvas.getBoundingClientRect();
  canvas.width  = rect.width * dpr;
  canvas.height = logicalHeight * dpr;

  canvas.style.height = logicalHeight + "px";

  const ctx = canvas.getContext("2d");
  ctx.setTransform(dpr,0,0,dpr,0,0);
  return ctx;
}

let ctx = setupCanvas();
window.addEventListener("resize", () => {
  ctx = setupCanvas();
});

/* ===== UI binding ===== */
const $ = id=>document.getElementById(id);

$("damper").checked = params.damper_enabled;
$("damper_strength").value = params.damper_strength;
$("V_amp").value = params.V_amp;
$("zeta").value = params.zeta;
$("refl_delay").value = params.refl_delay;
$("f0").value = params.f0;
$("refl_gain").value = params.refl_gain;

["damper","damper_strength","V_amp","zeta","refl_delay","f0","refl_gain"].forEach(id=>{
  $(id).oninput = e=>{
    params[id==="damper" ? "damper_enabled" : id] =
      (id==="damper") ? e.target.checked : Number(e.target.value);
    stack = computeStack(params);
  };
});

/* ===== animation ===== */
let stack = computeStack(params);
let cursor = 0;

function loop(){
  cursor += 0.35;
  if(cursor > params.T_us) cursor = 0;

  drawStack(ctx, stack, { cursor_us: cursor });

  $("status").textContent =
    `t = ${cursor.toFixed(2)} µs | damper = ${params.damper_enabled?"ON":"OFF"} | V_amp = ${params.V_amp.toFixed(0)} V`;

  requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
